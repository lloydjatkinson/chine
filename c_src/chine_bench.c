#include <stdio.h>
#include <stdlib.h>
#include <memory.h>
#include <unistd.h>
#include "../include/chine.h"

chine_t m;

extern int32_t chine_unix_sys(chine_t* mp,
			      int32_t sysop, int32_t* revarg,
			      int32_t* npop, int32_t* value);
// program that computes factorial(12) 1000 times
// and the prints the time in ms

// JUMP_TABLE
// -O0 = 1414 ms
// -O1 = 1003 ms
// -O2 = 885 ms
// -O3 = 886 ms
// SWITCH
// -O0 = 1611
// -O1 = 833
// -O2 = 545
// -O3 = 530
//


// program size=74, sha=26205b5a507aba3aa6b4048cb4ffa6887cd0c67c
uint8_t prog1[] = {
  0x19,0x0f,0x56,0x00,0x0f,0x42,0x40,0x45,0x06,0x19,0x0f,0xec,
  0x45,0x17,0x1a,0x46,0x0c,0x45,0x07,0x03,0x8e,0xc5,0x41,0xf7,
  0x03,0x18,0x00,0x8e,0xc5,0x40,0x04,0xc8,0xe7,0x44,0xf8,0x03,
  0x18,0x45,0x05,0x46,0x0a,0x19,0x0c,0x18,0x00,0x40,0x02,0x44,
  0x06,0x46,0x30,0x19,0x0c,0x03,0x18,0x00,0x46,0x0a,0xd2,0x11,
  0xef,0x46,0x30,0x06,0x19,0x0c,0x46,0x0a,0x11,0x00,0x41,0xef,
  0x03,0x18 };


void init()
{
    chine_init(&m, prog1, chine_unix_sys);
}

int main()
{
    uint8_t imask[NUM_IBYTES];   // input mask
    timeout_t tmo;

    init();
again:
    chine_run(&m);
    tmo = 0xffffffff;
    memset(&imask, 0, sizeof(imask));

    if (chine_next(&m, &tmo, imask)) { // wait for input or timer
	if (tmo < 0xffffffff) {
	    usleep(tmo*1000);
	    goto again;
	}
    }
    exit(0);
}
