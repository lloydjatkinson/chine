#include <stdio.h>
#include <stdlib.h>
#include <memory.h>
#include <unistd.h>
#include "../../include/chine.h"

chine_t m;

extern int32_t chine_unix_sys(chine_t* mp,
			      int32_t sysop, int32_t* revarg,
			      int32_t* npop, int32_t* value);
// program that computes factorial(12) 1000 times
// and the prints the time in ms

// JUMP_TABLE
// -O0 = 1414 ms
// -O1 = 1003 ms
// -O2 = 885 ms
// -O3 = 886 ms
// SWITCH
// -O0 = 1611
// -O1 = 833
// -O2 = 545
// -O3 = 530
//

/*
uint8_t prog1[] = {
  0x1a,0x0f,0x5f,0x00,0x0f,0x42,0x40,0x46,0x07,0x1a,0x0f,0x04,
  0x05,0x46,0x1b,0x1b,0x47,0x0c,0x46,0x08,0x03,0x8f,0x05,0x00,
  0x41,0xf6,0x03,0x19,0x00,0x8f,0x05,0x00,0x40,0x06,0x00,0x01,
  0x07,0x04,0x44,0xf5,0x03,0x19,0x46,0x05,0x47,0x0a,0x1a,0x0c,
  0x19,0x00,0x40,0x02,0x44,0x06,0x47,0x30,0x1a,0x0c,0x03,0x19,
  0x00,0x47,0x0a,0x02,0x02,0x14,0x07,0x05,0x47,0x30,0x06,0x1a,
  0x0c,0x47,0x0a,0x14,0x00,0x41,0xed,0x03,0x19 };
*/

uint8_t prog1[] = {
  0x1a,0x0f,0x5f,0x00,0x0f,0x42,0x40,0x46,0x06,0x1a,0x0f,0xec,
  0x46,0x17,0x1b,0x47,0x0c,0x46,0x07,0x03,0x8f,0xc5,0x41,0xf7,
  0x03,0x19,0x00,0x8f,0xc5,0x40,0x04,0xc8,0xe7,0x44,0xf8,0x03,
  0x19,0x46,0x05,0x47,0x0a,0x1a,0x0c,0x19,0x00,0x40,0x02,0x44,
  0x06,0x47,0x30,0x1a,0x0c,0x03,0x19,0x00,0x47,0x0a,0xd2,0x14,
  0xef,0x47,0x30,0x06,0x1a,0x0c,0x47,0x0a,0x14,0x00,0x41,0xef,
  0x03,0x19 };


void init()
{
    chine_init(&m, prog1, chine_unix_sys);
}

int main()
{
    int r1;
    int n;
    chine_t* mv[3];
    uint8_t imask[NUM_IBYTES];   // input mask
    timeout_t tmo;

    init();

    r1 = 0;
again:
    tmo = 0;
    n = 0;
    if (r1 == 0)
	r1 = chine_run(&m);
    if (r1 == 1) // yield
	mv[n++] = &m;
    if (n == 0)
	exit(0);
    chine_next(mv, n, &tmo, imask);
    if ((n == 1) && (tmo > 0))
	usleep(tmo*1000);
    r1 = 0;
    goto again;
}
